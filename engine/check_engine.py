import os
import re
from typing import Dict, Optional

from openai import OpenAI

# OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
client = OpenAI()
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4o-mini")

# ---------------------------------------------------------
# ã‚ã„ã¾ã„è¡¨ç¾ã®æ¤œå‡º
# ---------------------------------------------------------

AMBIGUOUS_PATTERNS = [
    r"ã‚ã‹ã‚‰ãªã„",
    r"åˆ†ã‹ã‚‰ãªã„",
    r"ä¸æ˜",
    r"è¦šãˆã¦ãªã„",
    r"è¦šãˆã¦ã„ãªã„",
    r"ã‚ã‚“ã¾ã‚Š",
    r"ã‚ã¾ã‚Š",
    r"ãã‚“ãªã«",
    r"ãã“ã¾ã§",
    r"ã¡ã‚‡ã£ã¨ã ã‘",
    r"å°‘ã—ã ã‘",
    r"å°‘ã—",
    r"ã¾ã‚ã¾ã‚",
    r"ã¼ã¡ã¼ã¡",
    r"ãªã‚“ã¨ãªã",
    r"é©å½“",
    r"ãƒ†ã‚­ãƒˆãƒ¼",
    r"ãƒ†ã‚­ãƒˆã‚¦",
    r"æ°—ãŒã™ã‚‹",
    r"ãã‚‰ã„ã‹ãª",
    r"ãã‚‰ã„ã‹ãª",
    r"ãã‚‰ã„ã ã¨æ€ã†",
    r"ãã‚‰ã„ã ã¨æ€ã†",
    r"ã‹ã‚‚",
    r"ã‹ãªï¼Ÿ",
    r"ã‹ã‚‚ã—ã‚Œãªã„",
    r"ãŸã¶ã‚“",
    r"å¤šåˆ†",
    r"ä½•æ™‚é–“ã‹",
    r"ä½•æ™‚é–“ãã‚‰ã„",
    r"ä½•åˆ†ã‹",
    r"ä½•åˆ†ãã‚‰ã„",
]


def contains_ambiguous(text: str) -> bool:
    if not text:
        return False
    lower = text.lower()
    for pat in AMBIGUOUS_PATTERNS:
        if re.search(pat, lower):
            return True
    return False


# ---------------------------------------------------------
# ãƒ—ãƒ¬ã‚¤æ™‚é–“ã®æŠ½å‡ºãƒ»åˆ†é¡
# ---------------------------------------------------------

def extract_play_minutes(text: str) -> Optional[int]:
    """æ—¥æœ¬èªã®ã€90åˆ†ã€ã€2æ™‚é–“ã€ãªã©ã‹ã‚‰ã€ãŠãŠã‚ˆãã®åˆ†æ•°ã‚’æŠ½å‡º"""
    if not text:
        return None

    hours = 0
    minutes = 0

    m_hour = re.search(r"(\d+)\s*æ™‚é–“", text)
    if m_hour:
        hours = int(m_hour.group(1))

    m_min = re.search(r"(\d+)\s*åˆ†", text)
    if m_min:
        minutes = int(m_min.group(1))

    if hours == 0 and minutes == 0:
        m_h = re.search(r"(\d+)\s*h", text.lower())
        m_m = re.search(r"(\d+)\s*m", text.lower())
        if m_h:
            hours = int(m_h.group(1))
        if m_m:
            minutes = int(m_m.group(1))

    total = hours * 60 + minutes
    return total if total > 0 else None


def classify_play_time(minutes: Optional[int]) -> str:
    if minutes is None:
        return "unknown"
    if minutes <= 30:
        return "short"
    if minutes <= 120:
        return "normal"
    if minutes <= 240:
        return "long"
    return "very_long"


# ---------------------------------------------------------
# ã‚¿ã‚°åˆ†é¡ï¼ˆç°¡æ˜“ï¼‰
# ---------------------------------------------------------

def classify_tags(answer: str):
    if not answer:
        return []

    a = answer.lower()
    tags = []

    if any(k in a for k in ["ç—›", "ã„ãŸã„", "é ­ç—›", "è…°ç—›", "è‚©ã“ã‚Š"]):
        tags.append("pain")

    if any(k in a for k in ["ç›®ãŒ", "çœ¼ç²¾ç–²åŠ´", "ã—ã‚‡ã¼ã—ã‚‡ã¼", "è¦–ç•Œ"]):
        tags.append("eye_strain")

    if any(k in a for k in ["ã ã‚‹", "ç–²ã‚Œ", "ã¤ã‹ã‚Œ", "å€¦æ€ "]):
        tags.append("fatigue")

    if any(k in a for k in ["ä¸å®‰", "ã‚¤ãƒ©ã‚¤ãƒ©", "è½ã¡è¾¼", "ã—ã‚“ã©ã„", "ã‚„ã‚‹æ°—ãŒå‡ºãªã„"]):
        tags.append("mental")

    return tags


# ---------------------------------------------------------
# ãƒˆãƒ¼ãƒ³åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬
# ---------------------------------------------------------

TEMPLATES: Dict[str, Dict[str, str]] = {
    "gentle_female": {
        "header": "ç­”ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã˜ã‚ƒã‚ã€ä¸€ç·’ã«ä»Šæ—¥ã®çŠ¶æ…‹ã‚’æ•´ç†ã—ã¦ã¿ã‚ˆã†ã‹ã€‚",
        "play_short": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šä»Šæ—¥ã¯çŸ­ã‚ã¿ãŸã„ã­ã€‚ã“ã®ãã‚‰ã„ãªã‚‰ä½“ã«ã¯ã‚„ã•ã—ã‚ã ã‚ˆã€‚",
        "play_normal": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã»ã©ã‚ˆã„é•·ã•ã ã­ã€‚ã„ã„é›†ä¸­ã®ä»•æ–¹ãŒã§ãã¦ã„ãã†ã€‚",
        "play_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šå°‘ã—é•·ã‚ã‹ã‚‚ã€‚ç–²ã‚ŒãŒæºœã¾ã‚‰ãªã„ã‚ˆã†ã«ã€ã“ã¾ã‚ã«ä¼‘æ†©ã‚’å…¥ã‚Œã‚ˆã†ã­ã€‚",
        "play_very_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã‹ãªã‚Šé•·æ™‚é–“ã¿ãŸã„ã€‚ä»Šæ—¥ã¯ã—ã£ã‹ã‚Šä½“ã¨å¿ƒã‚’ä¼‘ã¾ã›ã¦ã‚ã’ã¦ã»ã—ã„ãªã€‚",
        "condition_good": "â— ä½“èª¿ï¼šå¤§ããªä¸èª¿ã¯ãªã•ãã†ã§å®‰å¿ƒã—ãŸã‚ˆã€‚",
        "condition_bad": "â— ä½“èª¿ï¼šå°‘ã—ã—ã‚“ã©ãã†ã ã­â€¦ç„¡ç†ã ã‘ã¯ã—ãªã„ã§ã­ã€‚æ—©ã‚ã«ä¼‘ã‚“ã§ã»ã—ã„ãªã€‚",
        "sleep_good": "â— ç¡çœ ï¼šçœ ã‚Œã¦ã„ã‚‹ã¿ãŸã„ã§ã‚ˆã‹ã£ãŸã€‚ä»Šã®ãƒªã‚ºãƒ ã‚’å¤§äº‹ã«ã—ã¦ã„ã“ã†ã€‚",
        "sleep_bad": "â— ç¡çœ ï¼šã¡ã‚‡ã£ã¨è¶³ã‚Šã¦ã„ãªã„ã‹ã‚‚ã€‚ä»Šæ—¥ã¯æ—©ã‚ã«ç”»é¢ã‚’é–‰ã˜ã¦ã€ã‚†ã£ãã‚Šä¼‘ã‚“ã§ã­ã€‚",
        "mood_good": "â— æ°—åˆ†ï¼šè½ã¡ç€ã„ã¦ã„ã‚‹ã¿ãŸã„ã§ä½•ã‚ˆã‚Šã ã‚ˆã€‚",
        "mood_bad": "â— æ°—åˆ†ï¼šæ°—æŒã¡ãŒç–²ã‚Œã¦ã„ã‚‹ã¿ãŸã„ã ã­â€¦ã€‚ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªãã¦ã„ã„ã‹ã‚‰ã­ã€‚",
        "ai_intro": "\n---\næ°—ã«ãªã‚‹ã¨ã“ã‚ãŒã‚ã£ãŸã‹ã‚‰ã€å°‘ã—ã ã‘ç›¸æ£’ã‹ã‚‰ä¸€è¨€ã€‚",
        "footer": "ä»Šæ—¥ã¯ã“ã“ã¾ã§ã€‚ãŒã‚“ã°ã‚Šã™ããšã€ã¡ã‚ƒã‚“ã¨ä¼‘ã‚€æ™‚é–“ã‚‚ä½œã£ã¦ã‚ã’ã¦ã­ã€‚ã¾ãŸã„ã¤ã§ã‚‚è©±ã—ã«æ¥ã¦ã­ã€‚",
    },
    "bright_girl": {
        "header": "ç­”ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã€œï¼ã˜ã‚ƒã‚ä»Šæ—¥ã®çŠ¶æ…‹ã‚’ä¸€ç·’ã«ã¿ã¦ã¿ã‚ˆï¼",
        "play_short": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šä»Šæ—¥ã¯çŸ­ã‚ã§ã„ã„æ„Ÿã˜ï¼ã‚µã‚¯ãƒƒã¨éŠã¶æ—¥ãŒã‚ã£ã¦ã‚‚ã„ã„ã‚ˆã­ï¼",
        "play_normal": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã»ã©ã‚ˆã„é•·ã•ã ã­ã€œã€‚é›†ä¸­ã‚‚æ¥½ã—ã•ã‚‚ãƒãƒ©ãƒ³ã‚¹è‰¯ã•ãã†ï¼",
        "play_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã¡ã‚‡ã£ã¨é•·ã‚ã‹ã‚‚ï¼Ÿé€”ä¸­ã§ã‚¹ãƒˆãƒ¬ãƒƒãƒã¨ã‹æŒŸã‚ãŸã‚‰æœ€é«˜ï¼",
        "play_very_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šä»Šæ—¥ã¯ãŒã£ã¤ã‚Šã‚„ã£ãŸã­ã€œï¼ã§ã‚‚ä½“ã‚‚å¿ƒã‚‚ã‚ªãƒ¼ãƒãƒ¼ãƒ’ãƒ¼ãƒˆæ³¨æ„ã ã‚ˆï¼",
        "condition_good": "â— ä½“èª¿ï¼šç‰¹ã«å•é¡Œãªã•ãã†ã§ã‚ˆã‹ã£ãŸï¼",
        "condition_bad": "â— ä½“èª¿ï¼šã¡ã‚‡ã£ã¨ã¤ã‚‰ãã†â€¦ã€‚ä»Šæ—¥ã¯ã¬ã‚‹ã‚ã®ãŠé¢¨å‘‚ã¨ã‹ã©ã†ã‹ãªï¼Ÿ",
        "sleep_good": "â— ç¡çœ ï¼šã¡ã‚ƒã‚“ã¨çœ ã‚Œã¦ã‚‹ã¿ãŸã„ã§å®‰å¿ƒã—ãŸã‚ˆã€œï¼",
        "sleep_bad": "â— ç¡çœ ï¼šç¡çœ ãŒå°‘ãªã‚ã‹ã‚‚â€¦ã€‚å¯ã‚‹å‰ã«ã‚¹ãƒãƒ›ã‚’å°‘ã—æ—©ã‚ã«ç½®ã„ã¦ã¿ã‚‹ï¼Ÿ",
        "mood_good": "â— æ°—åˆ†ï¼šå‰å‘ããã†ã§ã“ã£ã¡ã¾ã§å…ƒæ°—ã‚‚ã‚‰ãˆã‚‹ï¼",
        "mood_bad": "â— æ°—åˆ†ï¼šãƒ¢ãƒ¤ãƒ¢ãƒ¤ãªæ„Ÿã˜ã‹ãªâ€¦ã€‚è©±ã—ãŸããªã£ãŸã‚‰ã„ã¤ã§ã‚‚èãã‚ˆï¼Ÿ",
        "ai_intro": "\n---\nã¡ã‚‡ã£ã¨æ°—ã«ãªã£ãŸã¨ã“ã‚ãŒã‚ã£ãŸã‹ã‚‰ã€ã‚ãŸã—ã‹ã‚‰ä¸€è¨€ï¼",
        "footer": "ä»Šæ—¥ã¯ã“ã“ã¾ã§ã€œï¼ç„¡ç†ã—ã™ããšã€è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã‚’å¤§äº‹ã«ã—ã¦ã‚ã’ã¦ã­ã€‚ã¾ãŸéŠã³ã«æ¥ã¦ï¼",
    },
    "cheerful_friend": {
        "header": "ã‚ã‚ŠãŒã¨ï¼ã˜ã‚ƒã‚ã€ä¸€ç·’ã«ä»Šæ—¥ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã‚ˆï¼",
        "play_short": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šä»Šæ—¥ã¯çŸ­ã‚ã§ã„ã„æ„Ÿã˜ï¼ä»–ã®ã“ã¨ã‚‚æ¥½ã—ã‚ãã†ã ã­ã€‚",
        "play_normal": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã»ã©ã‚ˆã„é•·ã•ã ã­ã€‚ã¡ã‚ƒã‚“ã¨æ¥½ã—ã‚ã¦ãã†ï¼",
        "play_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã¡ã‚‡ã£ã¨é•·ã‚ã‹ã‚‚ã€‚ç›®ã‚„è‚©ã€å›ºã¾ã£ã¦ãªã„ï¼Ÿè»½ãä¼¸ã°ã—ã¦ãŠã“ã£ã‹ã€‚",
        "play_very_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã‹ãªã‚Šé•·æ™‚é–“ã¿ãŸã„ã ã­â€¦ã€‚ä»Šæ—¥ã¯ã“ã“ã‚‰ã¸ã‚“ã§ä¸€åŒºåˆ‡ã‚Šã—ã‚ˆã£ã‹ã€‚",
        "condition_good": "â— ä½“èª¿ï¼šå¤§ããªä¸èª¿ã¯ãªã•ãã†ã§ã‚ˆã‹ã£ãŸï¼",
        "condition_bad": "â— ä½“èª¿ï¼šçµæ§‹ã¤ã‚‰ãã†ã ãªâ€¦ã€‚ä»Šæ—¥ã¯ç„¡ç†ã›ãšã€ã—ã£ã‹ã‚Šã‚±ã‚¢ã—ã‚ˆã€‚",
        "sleep_good": "â— ç¡çœ ï¼šã‚ã‚Šã¨çœ ã‚Œã¦ã‚‹ã¿ãŸã„ã§å®‰å¿ƒã—ãŸï¼",
        "sleep_bad": "â— ç¡çœ ï¼šç¡çœ ãŒè¶³ã‚Šã¦ãªã„ã‹ã‚‚â€¦ã€‚ä»Šæ—¥ã¯æ—©ã‚ã«å¸ƒå›£ã«ãƒ€ã‚¤ãƒ–ã—ã‚ˆã€‚",
        "mood_good": "â— æ°—åˆ†ï¼šæ°—æŒã¡ã¯å‰å‘ããã†ã§è‰¯ãï¼",
        "mood_bad": "â— æ°—åˆ†ï¼šã¡ã‚‡ã£ã¨ã—ã‚“ã©ãã†ãªæ°—é…â€¦ã€‚ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã‚ˆã†ã«ã­ã€‚",
        "ai_intro": "\n---\nã¡ã‚‡ã£ã¨æ°—ã«ãªã£ãŸã¨ã“ã‚ãŒã‚ã‚‹ã‹ã‚‰ã€ãƒ•ãƒ¬ãƒ³ãƒ‰ã¨ã—ã¦ä¸€è¨€ï¼",
        "footer": "ä»Šæ—¥ã¯ã“ã‚“ãªæ„Ÿã˜ã‹ãªï¼ã¾ãŸæ°—ã«ãªã£ãŸã¨ãã€ã„ã¤ã§ã‚‚å‘¼ã‚“ã§ã­ã€‚ä¸€ç·’ã«ã†ã¾ãä»˜ãåˆã£ã¦ã“ï¼",
    },
    "cool_girl": {
        "header": "å›ç­”ã‚’ç¢ºèªã—ãŸã€‚ã§ã¯ã€ä»Šæ—¥ã®çŠ¶æ…‹ã‚’æ•´ç†ã—ã¦ã„ã“ã†ã€‚",
        "play_short": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šä»Šæ—¥ã¯çŸ­ã‚ã ã€‚ãƒ¡ãƒªãƒãƒªã®ã‚ã‚‹éã”ã—æ–¹ã¨è¨€ãˆã‚‹ã€‚",
        "play_normal": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šãŠãŠã‚€ã­é©åˆ‡ãªç¯„å›²ã ã€‚æ‚ªããªã„ãƒãƒ©ãƒ³ã‚¹ã ãªã€‚",
        "play_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã‚„ã‚„é•·ã‚ã ã€‚ç–²åŠ´ã®è“„ç©ã«ã¯æ³¨æ„ã—ãŸã»ã†ãŒã„ã„ã€‚",
        "play_very_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šé•·æ™‚é–“ãƒ—ãƒ¬ã‚¤ã ã€‚æ„è­˜ã—ã¦ä¼‘æ†©ã‚’æŒŸã¾ãªã„ã¨ã€ç¢ºå®Ÿã«è² è·ãŒå¢—ã™ã€‚",
        "condition_good": "â— ä½“èª¿ï¼šå¤§ããªå•é¡Œã¯ãªã•ãã†ã ã€‚ä»Šã®çŠ¶æ…‹ã‚’ç¶­æŒã—ã¦ã„ã“ã†ã€‚",
        "condition_bad": "â— ä½“èª¿ï¼šä¸èª¿ã®ã‚µã‚¤ãƒ³ãŒå‡ºã¦ã„ã‚‹ã€‚ç„¡ç†ã‚’ç¶šã‘ã‚‹ã®ã¯è³¢æ˜ã§ã¯ãªã„ã€‚",
        "sleep_good": "â— ç¡çœ ï¼šçœ ã‚Šã¯å–ã‚Œã¦ã„ã‚‹ã‚ˆã†ã ã€‚è‰¯ã„ç¿’æ…£ã ãªã€‚",
        "sleep_bad": "â— ç¡çœ ï¼šç¡çœ ä¸è¶³ãŒç–‘ã‚ã‚Œã‚‹ã€‚é›†ä¸­åŠ›ã®ä½ä¸‹ã«ã‚‚ã¤ãªãŒã‚‹ãã€‚",
        "mood_good": "â— æ°—åˆ†ï¼šå¿ƒã®çŠ¶æ…‹ã¯æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ã‚‹ã‚ˆã†ã ã€‚",
        "mood_bad": "â— æ°—åˆ†ï¼šæ°—æŒã¡ãŒä¹±ã‚Œã¦ã„ã‚‹ã‚ˆã†ã ãªã€‚å¯¾å‡¦ã‚’å¾Œå›ã—ã«ã—ãªã„æ–¹ãŒã„ã„ã€‚",
        "ai_intro": "\n---\nã„ãã¤ã‹æ°—ã«ãªã‚‹ç‚¹ãŒã‚ã£ãŸã‹ã‚‰ã€å°‘ã—ã ã‘ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãŠã“ã†ã€‚",
        "footer": "ä»¥ä¸Šã ã€‚ä»Šæ—¥ã¯ã“ã“ã¾ã§ã«ã—ã¦ã€å¿…è¦ãªã‚‰ã—ã£ã‹ã‚Šä¼‘ã‚ã€‚æ¬¡ã«ä¼šã†ã¨ãã¯ã€ã¾ãŸçŠ¶æ³ã‚’æ•™ãˆã¦ãã‚Œã€‚",
    },
    "strict_female": {
        "header": "ã¡ã‚ƒã‚“ã¨ç­”ãˆãŸãªã€‚ã§ã¯ã€ä»Šæ—¥ã®çŠ¶æ…‹ã‚’ã—ã£ã‹ã‚Šè¦‹ã¦ã„ããã€‚",
        "play_short": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šä»Šæ—¥ã¯æ§ãˆã‚ã ãªã€‚ãã®ãã‚‰ã„ãªã‚‰æ‚ªããªã„ã€‚",
        "play_normal": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã¾ã‚å¦¥å½“ãªé•·ã•ã ã€‚ã†ã¾ãä»˜ãåˆãˆã¦ã„ã‚‹ã‚ˆã†ã ãªã€‚",
        "play_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šå°‘ã—ã‚„ã‚Šã™ãã ã€‚åŒºåˆ‡ã‚Šã‚’ã¤ã‘ã‚‹ç·´ç¿’ã‚‚ã—ã¦ã„ã“ã†ã€‚",
        "play_very_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šæ˜ã‚‰ã‹ã«é•·ã™ãã‚‹ã€‚ä½“ã‚’å£Šã—ã¦ã‹ã‚‰ã§ã¯é…ã„ãã€‚",
        "condition_good": "â— ä½“èª¿ï¼šä»Šã®ã¨ã“ã‚å¤§ããªå•é¡Œã¯ãªã•ãã†ã ã€‚",
        "condition_bad": "â— ä½“èª¿ï¼šãã®çŠ¶æ…‹ã§ç„¡ç†ã‚’é‡ã­ã‚‹ã®ã¯å±é™ºã ã€‚æ—©ã‚ã«ã‚±ã‚¢ã—ã‚ã€‚",
        "sleep_good": "â— ç¡çœ ï¼šç¡çœ ã¯å–ã‚Œã¦ã„ã‚‹ã‚ˆã†ã ã€‚ãã®èª¿å­ã§ç¶šã‘ã‚ã€‚",
        "sleep_bad": "â— ç¡çœ ï¼šç¡çœ ä¸è¶³ã¯ä¾®ã‚Œãªã„ã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚‚è½ã¡ã‚‹ãã€‚",
        "mood_good": "â— æ°—åˆ†ï¼šæ°—æŒã¡ã¯ãã“ã¾ã§ä¹±ã‚Œã¦ã„ãªã„ã‚ˆã†ã ãªã€‚",
        "mood_bad": "â— æ°—åˆ†ï¼šãƒ¡ãƒ³ã‚¿ãƒ«é¢ã®ç–²ã‚Œã‚‚è¦‹é€ƒã™ãªã€‚ä¼‘ã‚€ã“ã¨ã‚‚â€œåŠªåŠ›â€ã®ã†ã¡ã ã€‚",
        "ai_intro": "\n---\nå°‘ã—æ°—ã«ãªã‚‹ã¨ã“ã‚ãŒã‚ã£ãŸã‹ã‚‰ã€å¿ å‘Šã—ã¦ãŠãã€‚",
        "footer": "ä»Šæ—¥ã¯ã“ã“ã¾ã§ã ã€‚è‡ªåˆ†ã®ä½“ã¨å¿ƒã‚’ç²—æœ«ã«ã™ã‚‹ãªã‚ˆã€‚ã¾ãŸãƒã‚§ãƒƒã‚¯ã—ãŸããªã£ãŸã‚‰æ¥ã„ã€‚",
    },
    "calm_male": {
        "header": "æ•™ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã§ã¯ã€ä»Šæ—¥ã®æ§˜å­ã‚’ä¸€ç·’ã«æŒ¯ã‚Šè¿”ã£ã¦ã¿ã‚ˆã†ã€‚",
        "play_short": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šä»Šæ—¥ã¯çŸ­ã‚ã§ã€ã»ã©ã‚ˆãæ¥½ã—ã‚ãŸã¿ãŸã„ã ã­ã€‚",
        "play_normal": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã¡ã‚‡ã†ã©ã„ã„ãã‚‰ã„ã®é•·ã•ã‹ãªã€‚ã„ã„æ™‚é–“ã®ä½¿ã„æ–¹ã ã¨æ€ã†ã‚ˆã€‚",
        "play_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šå°‘ã—é•·ã‚ã ã£ãŸã­ã€‚èº«ä½“ã®æ–¹ã«ç–²ã‚ŒãŒæ®‹ã£ã¦ã„ãªã„ã‹å¿ƒé…ã ãªã€‚",
        "play_very_long": "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã‹ãªã‚Šé•·ã„æ™‚é–“ã ã£ãŸã¿ãŸã„ã ã€‚ä»Šæ—¥ã¯æ„è­˜ã—ã¦ä¼‘ã‚€æ™‚é–“ã‚’å–ã‚ã†ã€‚",
        "condition_good": "â— ä½“èª¿ï¼šå¤§ããªä¸èª¿ã¯ãªã•ãã†ã§ã€ã²ã¨å®‰å¿ƒã ã­ã€‚",
        "condition_bad": "â— ä½“èª¿ï¼šå°‘ã—ã¤ã‚‰ãã†ãªå°è±¡ã‚’å—ã‘ãŸã‚ˆã€‚ç„¡ç†ã‚’é‡ã­ãªã„ã‚ˆã†ã«ã—ã‚ˆã†ã€‚",
        "sleep_good": "â— ç¡çœ ï¼šçœ ã‚Œã¦ã„ã‚‹ã¿ãŸã„ã§å®‰å¿ƒã—ãŸã‚ˆã€‚ãã®èª¿å­ã§ç¶šã‘ã¦ã„ããŸã„ã­ã€‚",
        "sleep_bad": "â— ç¡çœ ï¼šç¡çœ ãŒè¶³ã‚Šã¦ã„ãªã„ã‹ã‚‚ã—ã‚Œãªã„ã­ã€‚ä»Šæ—¥ã¯æ—©ã‚ã«ä¼‘ã‚ã‚‹ã¨ã„ã„ãªã€‚",
        "mood_good": "â— æ°—åˆ†ï¼šæ°—æŒã¡ã¯æ¯”è¼ƒçš„è½ã¡ç€ã„ã¦ã„ã‚‹ã‚ˆã†ã ã­ã€‚",
        "mood_bad": "â— æ°—åˆ†ï¼šå¿ƒãŒå°‘ã—ãŠç–²ã‚Œæ°—å‘³ã‹ãªã€‚ã¡ã‚ƒã‚“ã¨è‡ªåˆ†ã‚’ã­ãã‚‰ã£ã¦ã‚ã’ã¦ã­ã€‚",
        "ai_intro": "\n---\nå°‘ã—ã ã‘æ°—ã«ãªã£ãŸã¨ã“ã‚ãŒã‚ã‚‹ã‹ã‚‰ã€ã•ã•ã‚„ã‹ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ·»ãˆã¦ãŠãã‚ˆã€‚",
        "footer": "ä»Šæ—¥ã¯ã“ã‚“ãªã¨ã“ã‚ã‹ãªã€‚ã¡ã‚ƒã‚“ã¨è‡ªåˆ†ã‚’ã„ãŸã‚ã‚ŠãªãŒã‚‰ã€ã¾ãŸæ˜æ—¥ã‚‚æ¥½ã—ãéã”ã—ã¦ã„ã“ã†ã€‚",
    },
}


# ---------------------------------------------------------
# AI è£œè¶³ç”Ÿæˆ
# ---------------------------------------------------------

def build_ai_prompt(
    tone: str,
    answers: Dict[str, str],
    minutes: Optional[int],
    tags_q2,
    tags_q4,
) -> Optional[str]:
    """æ¡ä»¶ã‚’æº€ãŸã™å ´åˆã®ã¿ AI ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—ã‚’è¿”ã™"""

    needs_ai = False

    for key in ["Q1", "Q2", "Q3", "Q4"]:
        if contains_ambiguous(answers.get(key, "")):
            needs_ai = True
            break

    warned_tags = set(tags_q2) | set(tags_q4)
    if any(t in warned_tags for t in ["pain", "eye_strain", "fatigue", "mental"]):
        needs_ai = True

    if not needs_ai:
        return None

    tone_label = {
        "gentle_female": "ã‚„ã•ã—ã„å¥³æ€§",
        "bright_girl": "æ˜ã‚‹ã„å¥³ã®å­",
        "cheerful_friend": "æ°—ã•ãã§å¿«æ´»ãªå¥³å­",
        "cool_girl": "ã‚¯ãƒ¼ãƒ«ãªå¥³æ€§",
        "strict_female": "å³ã—ã‚ã®å¥³æ€§",
        "calm_male": "è½ã¡ç€ã„ãŸç”·æ€§",
    }.get(tone, "ã‚„ã•ã—ã„å¥³æ€§")

    if minutes is None:
        play_summary = "ãƒ—ãƒ¬ã‚¤æ™‚é–“ã¯ã¯ã£ãã‚Šã¨ã¯ã‚ã‹ã‚‰ãªã„ã¨ç­”ãˆã¦ã„ã‚‹ã€‚"
    else:
        h = minutes // 60
        m = minutes % 60
        if h and m:
            play_summary = f"ãƒ—ãƒ¬ã‚¤æ™‚é–“ã¯ãŠã‚ˆã {h}æ™‚é–“{m}åˆ†ã€‚"
        elif h:
            play_summary = f"ãƒ—ãƒ¬ã‚¤æ™‚é–“ã¯ãŠã‚ˆã {h}æ™‚é–“ã€‚"
        else:
            play_summary = f"ãƒ—ãƒ¬ã‚¤æ™‚é–“ã¯ãŠã‚ˆã {m}åˆ†ã€‚"

    user_text = (
        f"Q1ï¼ˆãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼‰: {answers.get('Q1','')}\n"
        f"Q2ï¼ˆä½“èª¿ï¼‰: {answers.get('Q2','')}\n"
        f"Q3ï¼ˆç¡çœ ï¼‰: {answers.get('Q3','')}\n"
        f"Q4ï¼ˆæ°—åˆ†ï¼‰: {answers.get('Q4','')}"
    )

    system_prompt = (
        f"ã‚ãªãŸã¯æ—¥æœ¬èªã§è©±ã™{tone_label}ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚"
        "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚²ãƒ¼ãƒ ã®éŠã³ã™ãã‚„ç–²ã‚Œã™ããŒæ°—ã«ãªã£ã¦ã„ã‚‹äººã§ã™ã€‚"
        "ä»¥ä¸‹ã®å›ç­”ã‚’èª­ã¿ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è²¬ã‚ãšã«ã€ã‚„ã•ã—ããƒ»å…·ä½“çš„ã«ãƒ»100æ–‡å­—ä»¥å†…ã§ä¸€è¨€ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚"
        "ç¦æ­¢äº‹é …ï¼šè¨ºæ–­åã‚’ã¤ã‘ã‚‹ã€æ²»ç™‚è¡Œç‚ºã‚’æ–­å®šã™ã‚‹ã€è„…ã‹ã™è¡¨ç¾ã€‚"
    )

    user_prompt = (
        "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”:\n"
        f"{user_text}\n\n"
        f"{play_summary}\n"
        "æ°—ã«ãªã‚Šãã†ãªç‚¹ãŒã‚ã‚Œã°1ã€œ3å€‹ã ã‘ç°¡æ½”ã«è§¦ã‚Œã¦ãã ã•ã„ã€‚"
    )

    return system_prompt + "\n\n" + user_prompt


def call_openai(system_and_user_prompt: str) -> Optional[str]:
    """OpenAI API ã‚’å‘¼ã³å‡ºã—ã€ä¸€è¨€ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿”ã™"""
    try:
        system_prompt, user_prompt = system_and_user_prompt.split("\n\n", 1)
        resp = client.chat.completions.create(
            model=OPENAI_MODEL,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt},
            ],
            max_tokens=120,
            temperature=0.7,
        )
        return resp.choices[0].message.content.strip()
    except Exception:
        return None


# ---------------------------------------------------------
# ãƒ¡ã‚¤ãƒ³ï¼šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆ
# ---------------------------------------------------------

def generate_health_reply(tone: str, answers: Dict[str, str]) -> str:
    """
    tone: "gentle_female" ãªã©
    answers: {"Q1": "...", "Q2": "...", "Q3": "...", "Q4": "..."}
    """
    tone = tone or "gentle_female"
    tmpl = TEMPLATES.get(tone, TEMPLATES["gentle_female"])

    q1 = answers.get("Q1", "")
    q2 = answers.get("Q2", "")
    q3 = answers.get("Q3", "")
    q4 = answers.get("Q4", "")

    minutes = extract_play_minutes(q1)
    pt_class = classify_play_time(minutes)

    if pt_class == "short":
        play_text = tmpl["play_short"]
    elif pt_class == "normal":
        play_text = tmpl["play_normal"]
    elif pt_class == "long":
        play_text = tmpl["play_long"]
    elif pt_class == "very_long":
        play_text = tmpl["play_very_long"]
    else:
        play_text = "â— ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼šã¯ã£ãã‚Šã¨ã¯åˆ†ã‹ã‚‰ãªã„ã¿ãŸã„ã ã‘ã‚Œã©ã€è‡ªåˆ†ãªã‚Šã®â€œã‚„ã‚Šã™ããƒ©ã‚¤ãƒ³â€ã‚’æ„è­˜ã—ã¦ã¿ã‚ˆã†ã€‚"

    cond_tags = classify_tags(q2)
    mood_tags = classify_tags(q4)

    if "pain" in cond_tags or "fatigue" in cond_tags:
        cond_text = tmpl["condition_bad"]
    else:
        cond_text = tmpl["condition_good"]

    sleep_text_lower = q3.lower()
    if any(k in sleep_text_lower for k in ["çœ ã‚Œ", "å¯ã‚Œãª", "ã­ã‚€ã‚Œãª", "å¾¹å¤œ", "å…¨ç„¶å¯", "ã»ã¨ã‚“ã©å¯ã¦ãªã„"]):
        sleep_text = tmpl["sleep_bad"]
    else:
        sleep_text = tmpl["sleep_good"]

    if "mental" in mood_tags:
        mood_text = tmpl["mood_bad"]
    else:
        mood_text = tmpl["mood_good"]

    lines = [
        tmpl["header"],
        "",
        "ğŸ“Š ä»Šæ—¥ã®çŠ¶æ…‹ã¾ã¨ã‚",
        play_text,
        cond_text,
        sleep_text,
        mood_text,
    ]

    ai_prompt = build_ai_prompt(tone, answers, minutes, cond_tags, mood_tags)
    if ai_prompt:
        ai_msg = call_openai(ai_prompt)
        if ai_msg:
            lines.append(tmpl["ai_intro"])
            lines.append(ai_msg)

    lines.append("")
    lines.append(tmpl["footer"])

    return "\n".join(lines)
